name: Auto Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  # Wait for CI to pass
  ci-check:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'core'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

      - name: Wait for CLI CI
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'cli'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

      - name: Wait for App CI
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'app'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

      - name: Wait for Web CI
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'web'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  release:
    needs: ci-check
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.bump.outputs.new_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SPLIT_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get latest tag
        id: latest
        run: |
          LATEST=$(git tag -l "v*" --sort=-v:refname | head -1)
          if [ -z "$LATEST" ]; then
            LATEST="v0.0.0"
          fi
          echo "tag=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST"

      - name: Bump version
        id: bump
        run: |
          LATEST="${{ steps.latest.outputs.tag }}"
          # Remove 'v' prefix
          VERSION=${LATEST#v}
          
          # Split into major.minor.patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # Determine bump type
          BUMP="${{ github.event.inputs.bump || 'patch' }}"
          
          case $BUMP in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "New tag: $NEW_TAG"

      - name: Create and push tag
        run: |
          NEW_TAG="${{ steps.bump.outputs.new_tag }}"
          git tag -a "$NEW_TAG" -m "Release $NEW_TAG"
          git push origin "$NEW_TAG"
          echo "✓ Created and pushed tag: $NEW_TAG"

      - name: Create GitHub Release on monorepo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_TAG="${{ steps.bump.outputs.new_tag }}"
          gh release create "$NEW_TAG" \
            --title "Orbit $NEW_TAG" \
            --generate-notes \
            --repo ${{ github.repository }}

  # Build desktop app for macOS (DMG)
  build-desktop:
    needs: release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.new_tag }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, json, sqlite3
          tools: composer:v2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        working-directory: packages/desktop
        run: |
          composer install --no-dev --optimize-autoloader
          npm install

      - name: Build CLI phar with correct version
        run: |
          # Build CLI with proper version
          cd packages/cli
          
          # Replace path repos with packagist for release build
          jq 'del(.repositories)' composer.json > composer.tmp && mv composer.tmp composer.json
          rm -f composer.lock
          composer install --no-dev --no-scripts --optimize-autoloader --prefer-dist
          
          # Set version in config
          VERSION="${{ needs.release.outputs.new_tag }}"
          sed -i.bak "s/'version' => '[^']*'/'version' => '$VERSION'/g" config/app.php
          
          # Download box and compile
          wget -q https://github.com/box-project/box/releases/download/4.6.2/box.phar
          chmod +x box.phar
          php box.phar compile
          
          # Verify and copy to desktop
          php builds/orbit.phar --version
          cp builds/orbit.phar ../desktop/bin/orbit.phar
          echo "✓ CLI phar built and copied with version $VERSION"

      - name: Create .env for build
        working-directory: packages/desktop
        run: |
          cat > .env << 'EOF'
          APP_NAME=OrbitDesktop
          APP_ENV=production
          APP_DEBUG=false
          APP_URL=http://localhost
          DB_CONNECTION=sqlite
          NATIVEPHP_APP_ID=com.orbit.desktop
          EOF
          
          # Generate a proper APP_KEY
          php artisan key:generate
          
          # Set version from release tag
          echo "NATIVEPHP_APP_VERSION=${{ needs.release.outputs.new_tag }}" >> .env

      - name: Build desktop app
        working-directory: packages/desktop
        run: |
          php artisan native:build
        env:
          APP_ENV: production

      - name: Upload DMG to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_TAG="${{ needs.release.outputs.new_tag }}"
          
          # Find the built DMG files
          DMG_ARM=$(find packages/desktop -name "*arm64*.dmg" -type f | head -1)
          DMG_X64=$(find packages/desktop -name "*x64*.dmg" -o -name "*x86_64*.dmg" -type f | head -1)
          
          if [ -n "$DMG_ARM" ]; then
            gh release upload "$NEW_TAG" "$DMG_ARM" --repo ${{ github.repository }}
            echo "✓ Uploaded ARM64 DMG"
          fi
          
          if [ -n "$DMG_X64" ]; then
            gh release upload "$NEW_TAG" "$DMG_X64" --repo ${{ github.repository }}
            echo "✓ Uploaded x64 DMG"
          fi
