# Ralph Progress Log
Started: 2026-01-12

## Codebase Patterns

### Services
- Services live in `app/Services/`
- Use Process facade for shell commands
- ConfigManager handles ~/.config/launchpad/ paths

### Commands
- Commands in `app/Console/Commands/`
- Laravel Artisan command structure
- Use $this->info(), $this->error() for output

### Stubs
- Template files in `resources/stubs/`
- Placeholders use {{VARIABLE}} format

### Existing Code to Reference
- ProvisioningService.php - Linux PHP-FPM pool config generation
- CaddyfileGenerator.php - Caddyfile generation (currently for containers)
- tmp/HorizonStartCommand.php - Horizon management prototype

### macOS Specifics
- Homebrew prefix: /opt/homebrew/ (Apple Silicon)
- PHP from shivammathur/php tap
- brew services for service management
- launchctl for launchd services
- Plist in ~/Library/LaunchAgents/

---

## 2026-01-12 - STORY-1: Create MacPhpFpmService for pool config generation
**Changes:** app/Services/MacPhpFpmService.php (fixed PHPStan type errors)
**Learnings:** Service already existed from prior work. PHPStan requires explicit type handling for getenv() and superglobals. Use `is_string()` checks for mixed return values.
---

## 2026-01-12 - STORY-2: Create MacBrewService for Homebrew service management
**Changes:** app/Services/MacBrewService.php (new file)
**Learnings:** brew services list output can be parsed to check service status. The output contains "started" for running services.
---

## 2026-01-12 - STORY-3: Update CaddyfileGenerator for host Caddy + FPM sockets
**Changes:** app/Services/CaddyfileGenerator.php (new file)
**Learnings:** Uses php_fastcgi with unix sockets for PHP-FPM. Injects MacPhpFpmService for socket paths. setupSystemCaddyfile() imports launchpad config into Homebrew's Caddy.
---

## 2026-01-12 - STORY-4: Create MacHorizonService for launchd management
**Changes:** app/Services/MacHorizonService.php (new file)
**Learnings:** launchd plist uses ProgramArguments array, WorkingDirectory, EnvironmentVariables dict. launchctl load/unload for management. Check isRunning() by parsing launchctl list output for PID.
---

## 2026-01-12 - STORY-5: Create MigrateToFpmCommand
**Changes:** app/Console/Commands/MigrateToFpmCommand.php (new file)
**Learnings:** Command orchestrates all services. Uses --force flag for CI automation. Steps: check prerequisites, stop containers, install pool configs, start PHP-FPM, configure Caddy, install Horizon, cleanup old containers.
---

## 2026-01-12 - STORY-6: Update StatusCommand for FPM architecture
**Changes:** app/Console/Commands/StatusCommand.php (new file)
**Learnings:** Detects architecture by checking for PHP-FPM sockets. Displays brew services status for PHP-FPM/Caddy, launchctl for Horizon, docker inspect for containers. Uses typed arrays for PHPStan compliance.
---

## 2026-01-12 - STORY-7: Add FPM pool stub files
**Changes:** resources/stubs/mac-fpm-pool.stub, resources/stubs/horizon-launchd.plist.stub (new files)
**Learnings:** Stubs use {{VARIABLE}} placeholder format. macOS uses staff group. Homebrew prefix is /opt/homebrew/. plist uses XML format with PropertyList DTD.
---
