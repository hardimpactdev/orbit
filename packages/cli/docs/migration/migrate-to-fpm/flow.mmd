flowchart TD
    Start([migrate to-fpm]) --> DetectSetup[Detect current setup]
    
    DetectSetup --> CheckFpm{Using FPM?}
    CheckFpm -->|Yes| CheckContainers{FrankenPHP containers exist?}
    CheckContainers -->|No| AlreadyFpm[Already using PHP-FPM]
    AlreadyFpm --> SuccessExit([Success])
    
    CheckFpm -->|No| NeedsMigration[Needs migration]
    CheckContainers -->|Yes| NeedsMigration
    
    NeedsMigration --> CheckForce{--force or --json?}
    CheckForce -->|No| Confirm{User confirms?}
    Confirm -->|No| CancelExit([Cancelled])
    Confirm -->|Yes| StartMigration
    CheckForce -->|Yes| StartMigration
    
    StartMigration --> StopServices[Stop current services]
    StopServices --> InstallFpm[Install PHP-FPM 8.3 8.4]
    InstallFpm --> ConfigurePools[Configure FPM pools]
    ConfigurePools --> InstallCaddy[Install host Caddy if needed]
    InstallCaddy --> RegenCaddyfile[Regenerate Caddyfile]
    RegenCaddyfile --> ReloadCaddy[Reload Caddy]
    ReloadCaddy --> InstallHorizon[Install Horizon service]
    
    InstallHorizon --> CheckKeep{--keep-containers?}
    CheckKeep -->|No| RemoveContainers[Remove old Docker containers]
    CheckKeep -->|Yes| StartNew
    RemoveContainers --> StartNew[Start new services]
    
    StartNew --> ReportComplete[Migration complete]
    ReportComplete --> SuccessExit
