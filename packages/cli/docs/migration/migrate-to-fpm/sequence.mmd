sequenceDiagram
    participant User
    participant CLI as MigrateToFpm
    participant PM as PhpManager
    participant CM as CaddyManager
    participant CG as CaddyfileGenerator
    participant HM as HorizonManager
    participant DM as DockerManager

    User->>CLI: orbit migrate to-fpm
    CLI->>PM: Check FPM sockets exist
    CLI->>DM: Check FrankenPHP containers exist
    
    alt Already FPM no containers
        CLI-->>User: Already using PHP-FPM
    else Needs migration
        alt Not --force
            CLI-->>User: Confirm migration?
            User-->>CLI: Yes
        end
        
        CLI->>CLI: call stop command
        
        CLI->>PM: Install PHP 8.3 and 8.4
        CLI->>PM: Configure FPM pools
        
        CLI->>CM: isInstalled
        alt Not installed
            CLI->>CM: install
        end
        
        CLI->>CG: generate
        CLI->>CM: reload
        
        CLI->>HM: install
        
        alt Not --keep-containers
            loop For each old container
                CLI->>DM: containerExists
                alt Exists
                    CLI->>DM: stop
                    CLI->>DM: removeContainer
                end
            end
        end
        
        CLI->>CLI: call start command
        
        CLI-->>User: Migration complete
        CLI-->>User: FPM active Horizon active Caddy active
    end
