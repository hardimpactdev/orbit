{
  "branchName": "ralph/mac-php-fpm-migration",
  "title": "Mac PHP-FPM Migration Command",
  "description": "Implement the `launchpad migrate:to-fpm` command that migrates local Mac development from FrankenPHP containers to host PHP-FPM + host Caddy architecture, matching the remote VPS setup.",
  "stories": [
    {
      "id": "STORY-1",
      "title": "Create MacPhpFpmService for pool config generation",
      "priority": 1,
      "description": "Create app/Services/MacPhpFpmService.php that generates PHP-FPM pool configs for macOS. Should detect installed PHP versions from Homebrew (/opt/homebrew/opt/php@8.x/), generate pool configs with correct macOS paths (user = current user, group = staff, sockets at ~/.config/launchpad/php/), and symlink to Homebrew's php-fpm.d directories.",
      "acceptanceCriteria": [
        "Service class exists at app/Services/MacPhpFpmService.php",
        "detectInstalledPhpVersions() returns array of installed versions from Homebrew",
        "generatePoolConfig(string $version) creates correct pool config with macOS paths",
        "installPoolConfig(string $version) symlinks config to /opt/homebrew/etc/php/8.x/php-fpm.d/",
        "Uses $HOME and current username (not hardcoded paths)"
      ],
      "passes": true
    },
    {
      "id": "STORY-2",
      "title": "Create MacBrewService for Homebrew service management",
      "priority": 2,
      "description": "Create app/Services/MacBrewService.php that wraps `brew services` commands for starting/stopping/restarting PHP-FPM and Caddy services. Include methods to check service status.",
      "acceptanceCriteria": [
        "Service class exists at app/Services/MacBrewService.php",
        "startPhpFpm(string $version) runs `brew services start php@{version}`",
        "stopPhpFpm(string $version) runs `brew services stop php@{version}`",
        "restartPhpFpm(string $version) runs `brew services restart php@{version}`",
        "startCaddy(), stopCaddy(), restartCaddy() manage Caddy service",
        "isServiceRunning(string $service) checks brew services list"
      ],
      "passes": true
    },
    {
      "id": "STORY-3",
      "title": "Update CaddyfileGenerator for host Caddy + FPM sockets",
      "priority": 3,
      "description": "Add generateHostCaddyfile() method to CaddyfileGenerator that creates a Caddyfile for host Caddy using PHP-FPM unix sockets instead of reverse_proxy to containers. Add method to setup the main /opt/homebrew/etc/caddy/Caddyfile to import launchpad config.",
      "acceptanceCriteria": [
        "generateHostCaddyfile() creates Caddyfile with php_fastcgi directives pointing to ~/.config/launchpad/php/php8x.sock",
        "Caddyfile uses tls internal for HTTPS",
        "Includes Vite dev server proxy rules",
        "setupSystemCaddyfile() creates /opt/homebrew/etc/caddy/Caddyfile that imports ~/.config/launchpad/caddy/Caddyfile",
        "reload() uses `brew services reload caddy` on macOS"
      ],
      "passes": true
    },
    {
      "id": "STORY-4",
      "title": "Create MacHorizonService for launchd management",
      "priority": 4,
      "description": "Create app/Services/MacHorizonService.php that generates launchd plist for Horizon and manages it via launchctl. Plist should be placed at ~/Library/LaunchAgents/com.launchpad.horizon.plist.",
      "acceptanceCriteria": [
        "Service class exists at app/Services/MacHorizonService.php",
        "generatePlist() creates valid launchd plist XML",
        "Plist runs php artisan horizon from correct working directory",
        "install() writes plist to ~/Library/LaunchAgents/ and loads with launchctl",
        "uninstall() unloads and removes plist",
        "isRunning() checks launchctl list for horizon"
      ],
      "passes": true
    },
    {
      "id": "STORY-5",
      "title": "Create MigrateToFpmCommand",
      "priority": 5,
      "description": "Create app/Console/Commands/MigrateToFpmCommand.php that orchestrates the migration. Uses MacPhpFpmService, MacBrewService, CaddyfileGenerator, and MacHorizonService to perform full migration.",
      "acceptanceCriteria": [
        "Command registered as `migrate:to-fpm`",
        "Checks prerequisites (PHP versions, Caddy installed via Homebrew)",
        "Stops current FrankenPHP containers",
        "Generates and installs PHP-FPM pool configs",
        "Starts PHP-FPM services",
        "Generates host Caddyfile and reloads Caddy",
        "Installs and starts Horizon launchd service",
        "Removes old FrankenPHP containers",
        "--force flag skips confirmation prompts"
      ],
      "passes": true
    },
    {
      "id": "STORY-6",
      "title": "Update StatusCommand for FPM architecture",
      "priority": 6,
      "description": "Update the status command to detect and display PHP-FPM architecture. Show brew services status for PHP-FPM and Caddy, launchctl status for Horizon, and docker status for remaining containers (postgres, redis, etc.).",
      "acceptanceCriteria": [
        "Status command detects architecture type (fpm vs frankenphp)",
        "Shows PHP-FPM pool status from brew services",
        "Shows Caddy status from brew services",
        "Shows Horizon status from launchctl",
        "Shows Docker container status for postgres, redis, mailpit, reverb, dns",
        "JSON output includes architecture field"
      ],
      "passes": true
    },
    {
      "id": "STORY-7",
      "title": "Add FPM pool stub files",
      "priority": 7,
      "description": "Create stub files in resources/stubs/ for PHP-FPM pool configs (mac-fpm-pool.stub) and Horizon launchd plist (horizon-launchd.plist.stub) with placeholder variables.",
      "acceptanceCriteria": [
        "resources/stubs/mac-fpm-pool.stub exists with {{VERSION}}, {{USER}}, {{HOME}}, {{SOCKET_PATH}}, {{LOG_PATH}} placeholders",
        "resources/stubs/horizon-launchd.plist.stub exists with {{USER}}, {{HOME}}, {{PHP_PATH}}, {{ARTISAN_PATH}} placeholders",
        "Stubs use correct macOS paths (/opt/homebrew/, staff group)"
      ],
      "passes": false
    },
    {
      "id": "STORY-8",
      "title": "Add prerequisite check command",
      "priority": 8,
      "description": "Create app/Console/Commands/DoctorCommand.php that checks all prerequisites for PHP-FPM migration: Homebrew installed, PHP versions from shivammathur/php, Caddy installed, Docker running.",
      "acceptanceCriteria": [
        "Command registered as `doctor`",
        "Checks Homebrew is installed",
        "Checks PHP 8.3, 8.4, 8.5 installed from shivammathur/php",
        "Checks Caddy installed via Homebrew",
        "Checks Docker is running",
        "Reports missing prerequisites with install instructions",
        "Returns exit code 0 if all pass, 1 if any fail"
      ],
      "passes": false
    }
  ]
}
