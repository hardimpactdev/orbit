name: Split Packages

on:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:

jobs:
  split:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - local: core
            remote: orbit-core
          - local: app
            remote: orbit-app
          - local: cli
            remote: orbit-cli
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install splitsh-lite
        run: |
          curl -sL https://github.com/splitsh/lite/releases/download/v1.0.1/lite_linux_amd64.tar.gz | tar xz
          sudo mv splitsh-lite /usr/local/bin/

      - name: Split ${{ matrix.package.local }}
        id: split
        run: |
          SHA=$(splitsh-lite --prefix=packages/${{ matrix.package.local }})
          echo "Split SHA: $SHA"
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      - name: Push to ${{ matrix.package.remote }}
        run: |
          git remote add ${{ matrix.package.remote }} https://x-access-token:${{ secrets.SPLIT_TOKEN }}@github.com/hardimpactdev/${{ matrix.package.remote }}.git || true
          git push ${{ matrix.package.remote }} ${{ steps.split.outputs.sha }}:refs/heads/main --force
          
      - name: Push tags
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          git push ${{ matrix.package.remote }} ${{ github.ref }} --force
