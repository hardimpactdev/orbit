sequenceDiagram
    participant User
    participant CLI as SchemaMigrate
    participant DS as DatabaseService
    participant FS as FileSystem
    participant DB as SQLite

    User->>CLI: orbit schema migrate
    CLI->>DS: getDbPath
    DS-->>CLI: dbPath
    
    CLI->>FS: Check database exists
    alt No database
        FS-->>CLI: false
        CLI-->>User: Will be initialized on first use
    else Database exists
        FS-->>CLI: true
        CLI->>DS: getPdo
        DS-->>CLI: PDO connection
        
        CLI->>DB: Check for projects table
        CLI->>DB: Check for sites table
        
        alt Has projects table with path column
            CLI->>DB: PRAGMA table_info projects
            DB-->>CLI: columns info
            
            alt Dry run
                CLI-->>User: Would migrate projects to sites
            else Real migration
                CLI->>FS: Create backup with timestamp
                
                alt Sites table exists
                    CLI->>DB: INSERT OR IGNORE INTO sites FROM projects
                    CLI->>DB: DROP TABLE projects
                else No sites table
                    CLI->>DB: ALTER TABLE projects RENAME TO sites
                    CLI->>DB: ALTER TABLE sites RENAME COLUMN name TO slug
                end
                
                CLI->>DB: ALTER TABLE sites ADD COLUMN project_id
                CLI-->>User: Migration complete
            end
        else No migration needed
            CLI-->>User: No migration needed
        end
    end
