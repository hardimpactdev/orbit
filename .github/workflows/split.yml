name: Split Packages

on:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:

jobs:
  split:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - local: core
            remote: orbit-core
          - local: app
            remote: orbit-app
          - local: cli
            remote: orbit-cli
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install splitsh-lite
        run: |
          curl -sL https://github.com/splitsh/lite/releases/download/v1.0.1/lite_linux_amd64.tar.gz | tar xz
          sudo mv splitsh-lite /usr/local/bin/

      - name: Split and push ${{ matrix.package.local }}
        run: |
          SHA=$(splitsh-lite --prefix=packages/${{ matrix.package.local }})
          echo "Split SHA: $SHA"
          
          # Configure git credentials for target repo
          git config --global url."https://x-access-token:${{ secrets.SPLIT_TOKEN }}@github.com/".insteadOf "https://github.com/"
          
          # Push split SHA directly to target repo
          git remote add ${{ matrix.package.remote }} https://github.com/hardimpactdev/${{ matrix.package.remote }}.git || true
          git push ${{ matrix.package.remote }} ${SHA}:refs/heads/main --force
          
      - name: Push tags
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          SHA=$(splitsh-lite --prefix=packages/${{ matrix.package.local }})
          
          # Create local tag pointing to split SHA and push
          git tag -f $TAG $SHA
          git push ${{ matrix.package.remote }} $TAG --force
